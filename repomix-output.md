This file is a merged representation of the entire codebase, combined into a single document.
Generated by Repomix on: 2025-03-29T21:22:15.104Z

# File Summary

## Purpose
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.

## File Format
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Multiple file entries, each consisting of:
  a. A header with the file path (## File: path/to/file)
  b. The full contents of the file in a code block

## Usage Guidelines
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.

## Notes
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded

## Additional Info

# Directory Structure
```
GeoLite2-City_20250321/
  COPYRIGHT.txt
  LICENSE.txt
  README.txt
src/
  cache.rs
  geolocator.rs
  main.rs
  updater.rs
  web.rs
.gitignore
Cargo.toml
```

# Files

## File: GeoLite2-City_20250321/COPYRIGHT.txt
```
Database and Contents Copyright (c) 2025 MaxMind, Inc.
```

## File: GeoLite2-City_20250321/LICENSE.txt
```
Use of this MaxMind product is governed by MaxMind's GeoLite2 End User License Agreement, which can be viewed at https://www.maxmind.com/en/geolite2/eula.

This database incorporates GeoNames [https://www.geonames.org] geographical data, which is made available under the Creative Commons Attribution 4.0 License. To view a copy of this license, visit https://creativecommons.org/licenses/by/4.0/.
```

## File: GeoLite2-City_20250321/README.txt
```
Latitude and longitude are not precise and should not be used to identify a particular street address or household.
```

## File: src/cache.rs
```rust
use lru::LruCache;
use std::sync::Mutex;
use std::net::IpAddr;
use std::usize;
use std::num::NonZeroUsize;

pub struct  GeoCache {
    cache: Mutex<LruCache<IpAddr, String>>,
}

impl GeoCache {
    pub fn new(size: usize) -> Self {
        let cache_size = NonZeroUsize::new(size).unwrap();
        Self {
            cache: Mutex::new(LruCache::new(cache_size)),
        }
    }

    pub fn get(&self, ip:IpAddr) -> Option<String> {
        self.cache.lock().unwrap().get(&ip).cloned()
    }

    pub fn insert(&self, ip:IpAddr, result:String) {
        self.cache.lock().unwrap().put(ip, result);
    }
}
```

## File: src/geolocator.rs
```rust
use maxminddb::Reader;
use std::net::IpAddr;
use std::error::Error;

#[derive(Debug, serde::Serialize)]
pub struct GeoData {
    pub country: Option<String>,
    pub city: Option<String>,
    pub latitude: Option<f64>,
    pub longitude: Option<f64>,
    pub timezone: Option<String>,
}

pub struct GeoLocator {
    reader: Reader<Vec<u8>>,
}

impl GeoLocator {
    pub fn new(db_path: &str) -> Result<Self, Box<dyn Error>> {
        let reader = Reader::open_readfile(db_path)?;
        Ok(Self {reader})
    }

    pub fn lookup(&self, ip: &str) -> Result<GeoData, Box<dyn Error>> {
        let ip: IpAddr = ip.parse()?;
        let result: maxminddb::geoip2::City = self.reader.lookup(ip)?;

        Ok(GeoData { 
            country: result.country
                .and_then(|c| c.names)
                .and_then(|names| names.get("en").map(|s| s.to_string())),
            city: result.city
                .and_then(|c| c.names)
                .and_then(|names| names.get("en").map(|s| s.to_string())), 
            latitude: result.location.as_ref().and_then(|l| l.latitude), 
            longitude: result.location.as_ref().and_then(|l| l.longitude), 
            timezone: result.location.as_ref().and_then(|l| l.time_zone).map(String::from),
        
         })
    }

}
```

## File: src/main.rs
```rust
mod geolocator;
mod updater;
mod cache;
mod web;

use geolocator::GeoLocator;

fn main() {
    let locator = GeoLocator::new("GeoLite2-City_20250321/GeoLite2-City.mmdb").expect("Failed to load DB");

    let ip = "8.8.8.8";
    match locator.lookup(ip) {
        Ok(data) => println!("{:?}", data),
        Err(e) => eprintln!("Error: {:?}", e),
    }
}
```

## File: src/updater.rs
```rust
use std::process::Command;
use std::fs;

pub fn update_database(){
    let url = "https://download.maxmind.com/geoip/databases/GeoLite2-City/download?suffix=tar.gz";

    let output = Command::new("wget")
        .arg("-0")
        .arg("GeoLite2-City.tar.gz")
        .arg(url)
        .output()
        .expect("Failed to download DB");

    if output.status.success() {
        println!("Extracting new database...");
        Command::new("tar")
            .arg("-xzf")
            .arg("Geolite2-City.tar.gz")
            .output()
            .expect("Failed to extract DB");

        fs::rename("Geolite@-City.mmdb", "/opt/geoip/GeoLite2-City.mmdb")
            .expect("Failed to move new DB");
        println!("Database updated successfully");
    } else {
        println!("Failed to update Database");
    }
}
```

## File: src/web.rs
```rust
use crate::GeoLocator;
use axum::{Router, routing::get, Json};
use serde_json;

#[tokio::main]
async fn main() {
    let app = Router::new().route("/lookup/:ip", get(handle_lookup));
    let listener = tokio::net::TcpListener::bind("0.0.0.0:8080").await.unwrap();
    println!("Server running on port {:?}", &listener);
    axum::serve(listener, app).await.unwrap();
    
}

async fn handle_lookup(ip: axum::extract::Path<String>) -> Json<String> {
    let locator = GeoLocator::new("GeoLite2-City.mmdb").unwrap();
    let result = locator.lookup(&ip).unwrap();
    Json(serde_json::to_string(&result).unwrap())
}
```

## File: .gitignore
```
/target
```

## File: Cargo.toml
```toml
[package]
name = "ip-geolocator"
version = "0.1.0"
edition = "2024"

[dependencies]
maxminddb = "0.25.0"
serde = { version = "1.0", features = ["derive"] }
tokio = { version = "1.44.1", features = ["full"] }
dotenv = "0.15.0"
memmap = "0.7.0"
lru = "0.13.0"
axum = "0.8.1"
serde_json = "1.0.140"
```
